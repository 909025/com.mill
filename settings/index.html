<!doctype html>
<html>
<head>
	<script type="text/javascript" src="/homey.js" data-origin="settings"></script>
</head>
<body>
  <h1 data-i18n="settings.title" ></h1>
	<p data-i18n="settings.intro"></p>
	<fieldset>
		<legend data-i18n="settings.account.credentials"></legend>
		<div class="field row">
				<label for="username" data-i18n="settings.account.fieldUsername"></label>
				<input id="username" type="text" value="" />
		</div>
		<div class="field row">
			<label for="password" data-i18n="settings.account.fieldPassword"></label>
			<input id="password" type="password" value="" />
		</div>
		<button id="clear" class="left"><i class="fa fa-trash-o"></i> <span data-i18n="settings.account.buttonClear">/<span></button>
	</fieldset>
  <fieldset>
	  <legend data-i18n="settings.account.settings"></legend>
	  <div class="field row">
		  <label for="interval" data-i18n="settings.account.fieldPolling"></label>
		  <input id="interval" type="number" value="60" min="60" max="3600" />
	  </div>
  </fieldset>
	<button id="save" class="right"><i class="fa fa-save"></i> <span data-i18n="settings.account.buttonSave"></span></button>

	<script type="text/javascript">

	function onHomeyReady(Homey) {
        var usernameElement = document.getElementById('username');
        var passwordElement = document.getElementById('password');
        var intervalElement = document.getElementById('interval');
        var saveElement = document.getElementById('save');
				var clearElement = document.getElementById('clear');

        Homey.get('username', function (err, name) {
            if (err) return Homey.alert(err);
            usernameElement.value = name;
        });

        Homey.get('password', function (err, password) {
            if (err) return Homey.alert(err);
            passwordElement.value = password;
        });

        Homey.get('interval', function (err, interval) {
            if (err) return Homey.alert(err);
            intervalElement.value = interval;
        });

				clearElement.addEventListener('click', function (e) {
					Homey.api('POST', '/clearSettings', {},
						function (err, result) {
							if (err) {
								return Homey.alert(
									Homey.__('settings.account.messages.errorClearing', {error: err})
								);
							}

							Homey.set('username', '', function (err) {
									if (err) return Homey.alert(err);
									usernameElement.value = '';
							});

							Homey.set('password', '', function (err) {
									if (err) return Homey.alert(err);
									passwordElement.value = '';
							});

						Homey.alert(
							Homey.__('settings.account.messages.successClearing')
						);
					});
				});

        saveElement.addEventListener('click', function (e) {
            Homey.set('interval', intervalElement.value || 60, function (err) {
                if (err) return Homey.alert(err);
            });

            Homey.api('POST', '/authenticate', {
                'username': usernameElement.value,
                'password': passwordElement.value
            }, function (err, result) {
                if (err) {
									return Homey.alert(
										Homey.__('settings.account.messages.errorSaving', {error: err})
									);
								}

                Homey.set('username', usernameElement.value, function (err) {
                    if (err) return Homey.alert(err);
                });

                Homey.set('password', passwordElement.value, function (err) {
                    if (err) return Homey.alert(err);
                });

                Homey.alert(
									Homey.__('settings.account.messages.successSaving')
								);
            });
        });

        Homey.ready();
    }
	</script>
 </body>
</html>
